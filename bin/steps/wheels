#!/usr/bin/env bash

$BIN_DIR/utils

bpwatch start wheels_install

if [ -d cf/wheels ]; then
  export PATH="/app/.heroku/vendor/bin:/app/.heroku/python/bin":"${PATH}"
  export LD_LIBRARY_PATH="/app/.heroku/vendor/lib/:/app/.heroku/python/lib/":"{$LD_LIBRARY_PATH}"
  export LIBRARY_PATH="/app/.heroku/vendor/lib/:/app/.heroku/python/lib/":"${LIBRARY_PATH}"
  export INCLUDE_PATH="/app/.heroku/vendor/include/":"${INCLUDE_PATH}"
  export PKG_CONFIG_PATH="/app/.heroku/vendor/lib/pkgconfig":"${PKG_CONFIG_PATH}"
  export CPATH="${INCLUDE_PATH}"
  export CPPPATH="${INCLUDE_PATH}"
  count=$(find cf/wheels -maxdepth 1 -name '*.whl' | wc -l)
  if [ $count != 0 ]; then
    wheels=""
    pushd cf/wheels &> /dev/null
    for whl in *.whl
    do
      count=0
      for exclude in $PIP_EXCLUDES
      do
        if [[ $whl == *${exclude}* ]]; then
          ((count++))
        fi
      done
      if [ $count == 0 ]; then
        echo "-----> Bootstrapping ${whl}"
        wheels+="${whl} "
      fi
    done
    /app/.heroku/python/bin/pip install  $wheels
    popd &> /dev/null
  fi
fi

bpwatch stop wheels_install
